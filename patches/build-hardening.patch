Copyright 2024-2025 The Trivalent Authors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is
distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
---
diff --git a/build/config/compiler/BUILD.gn b/build/config/compiler/BUILD.gn
index 59942a3cf6..c80eadf2c0 100644
--- a/build/config/compiler/BUILD.gn
+++ b/build/config/compiler/BUILD.gn
@@ -373,12 +373,18 @@ config("compiler") {
       # On Aarch64, SCS requires the x18 register to be unused because it will hold
       # a pointer to the shadow stack. For Android we know that Clang doesn't use
       # x18 by default. On other OSs adding "-ffixed-x18" might be required.
-      assert(is_android)
+      assert(is_android || is_linux)
 
       scs_parameters = [
         "-fsanitize=shadow-call-stack",
-        "-fno-stack-protector",
+        "-fstack-protector-strong",
       ]
+
+      # fixed-x18 may be required for ShadowCallStack
+      if (is_linux) {
+        scs_paramaters += [ "-ffixed-x18" ]
+      }
+
       cflags += scs_parameters
       ldflags += scs_parameters
     } else {
@@ -400,6 +406,11 @@ config("compiler") {
       }
     }
 
+    if (is_linux) {
+      cflags += [ "-fstack-clash-protection" ]
+      cflags += [ "-mharden-sls=all" ]
+    }
+
     if (use_lld) {
       ldflags += [ "-fuse-ld=lld" ]
       if (lld_path != "") {
@@ -2282,7 +2293,7 @@ config("chromium_code") {
       # Non-chromium code is not guaranteed to compile cleanly with
       # _FORTIFY_SOURCE. Also, fortified build may fail when optimizations are
       # disabled, so only do that for Release build.
-      fortify_level = "2"
+      fortify_level = "3"
 
       # ChromeOS's toolchain supports a high-quality _FORTIFY_SOURCE=3
       # implementation with a few custom glibc patches. Use that if it's
@@ -3363,8 +3374,14 @@ buildflag_header("compiler_buildflags") {
 }
 
 config("cet_shadow_stack") {
-  if (enable_cet_shadow_stack && is_win) {
+  if (enable_cet_shadow_stack) {
     assert(target_cpu == "x64")
-    ldflags = [ "/CETCOMPAT" ]
+    if (is_win) {
+      ldflags = [ "/CETCOMPAT" ]
+    } else if (is_linux) {
+      cflags = [ "-fcf-protection=full" ]
+      ldflags = [ "-fcf-protection=full", "-Wl,-z,shstk" ]
+      rustflags = [ "-Zcf-protection=full" ]
+    }
   }
 }
diff --git a/build/config/linux/BUILD.gn b/build/config/linux/BUILD.gn
index 131bb71d1d..9c20a89eec 100644
--- a/build/config/linux/BUILD.gn
+++ b/build/config/linux/BUILD.gn
@@ -19,12 +19,15 @@ config("compiler") {
     import("//build/config/arm.gni")
     cflags = []
     asmflags = []
+    rustflags = []
     if (arm_control_flow_integrity == "standard") {
-      cflags += [ "-mbranch-protection=standard" ]
-      asmflags += [ "-mbranch-protection=standard" ]
+      cflags += [ "-mbranch-protection=pac-ret+leaf+bti" ]
+      asmflags += [ "-mbranch-protection=pac-ret+leaf+bti" ]
+      rustflags += [ "-Zbranch-protection=bti,pac-ret,leaf" ]
     } else if (arm_control_flow_integrity == "pac") {
-      cflags += [ "-mbranch-protection=pac-ret" ]
-      asmflags += [ "-mbranch-protection=pac-ret" ]
+      cflags += [ "-mbranch-protection=pac-ret+leaf" ]
+      asmflags += [ "-mbranch-protection=pac-ret+leaf" ]
+      rustflags += [ "-Zbranch-protection=pac-ret,leaf" ]
     }
   }
 }

Copyright 2024-2025 The Trivalent Authors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is
distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
---
diff --git a/content/common/gpu_pre_sandbox_hook_linux.cc b/content/common/gpu_pre_sandbox_hook_linux.cc
index 2e53794fa3..0ae94f67a4 100644
--- a/content/common/gpu_pre_sandbox_hook_linux.cc
+++ b/content/common/gpu_pre_sandbox_hook_linux.cc
@@ -48,8 +48,8 @@ using sandbox::syscall_broker::BrokerProcess;
 namespace content {
 namespace {

-inline bool IsChromeOS() {
-#if BUILDFLAG(IS_CHROMEOS)
+inline bool IsLinux() {
+#if BUILDFLAG(IS_LINUX)
   return true;
 #else
   return false;
@@ -86,7 +86,7 @@ inline bool UseV4L2Codec(
 static const char kMaliConfPath[] = "/etc/mali_platform.conf";
 #endif

-#if BUILDFLAG(IS_CHROMEOS) && defined(__aarch64__)
+#if defined(__aarch64__)
 static const char kLibGlesPath[] = "/usr/lib64/libGLESv2.so.2";
 static const char kLibEglPath[] = "/usr/lib64/libEGL.so.1";
 static const char kLibMaliPath[] = "/usr/lib64/libmali.so";
@@ -100,7 +100,7 @@ static const char kLibTegraPath[] = "/usr/lib/libtegrav4l2.so";

 constexpr int dlopen_flag = RTLD_NOW | RTLD_GLOBAL | RTLD_NODELETE;

-void AddStandardChromeOsPermissions(
+void AddStandardLinuxPermissions(
     std::vector<BrokerFilePermission>* permissions) {
   // For the ANGLE passthrough command decoder.
   static const char* const kReadOnlyList[] = {"libEGL.so", "libGLESv2.so"};
@@ -257,6 +257,11 @@ void AddAmdGpuPermissions(std::vector<BrokerFilePermission>* permissions) {
       // that requires the following libs and files to be accessible.
       "/usr/lib64/libEGL.so.1",
       "/usr/lib64/libGLESv2.so.2",
+#if !BUILDFLAG(IS_CHROMEOS)
+      "/usr/lib64/libwayland-server.so.0",
+      "/usr/lib64/gbm/dri_gbm.so",
+      "/usr/lib64/dri/iHD_drv_video.so",
+#endif
       "/usr/lib64/libglapi.so.0",
       "/usr/lib64/libgallium_dri.so",
       "/usr/lib64/dri/r300_dri.so",
@@ -298,6 +303,9 @@ void AddNvidiaGpuPermissions(std::vector<BrokerFilePermission>* permissions) {
       // that requires the following libs and files to be accessible.
       "/etc/ld.so.cache",
       "/usr/lib64/libgallium_dri.so",
+#if !BUILDFLAG(IS_CHROMEOS)
+      "/usr/lib64/gbm/dri_gbm.so",
+#endif
       "/usr/lib64/dri/nouveau_dri.so",
       "/usr/lib64/dri/radeonsi_dri.so",
       "/usr/lib64/dri/swrast_dri.so",
@@ -324,6 +332,10 @@ void AddIntelGpuPermissions(std::vector<BrokerFilePermission>* permissions) {
       // To support threads in mesa we use --gpu-sandbox-start-early and
       // that requires the following libs and files to be accessible.
       "/usr/lib64/libgallium_dri.so",
+#if !BUILDFLAG(IS_CHROMEOS)
+      "/usr/lib64/gbm/dri_gbm.so",
+      "/usr/lib64/dri/iHD_drv_video.so",
+#endif
       "/usr/lib64/libEGL.so.1", "/usr/lib64/libGLESv2.so.2",
       "/usr/lib64/libelf.so.1", "/usr/lib64/libglapi.so.0",
       "/usr/lib64/libdrm_amdgpu.so.1", "/usr/lib64/libdrm_radeon.so.1",
@@ -363,6 +375,11 @@ void AddVirtIOGpuPermissions(std::vector<BrokerFilePermission>* permissions) {
       "/usr/lib64/libglapi.so.0",
       "/usr/lib64/libc++.so.1",
       "/usr/lib64/libgallium_dri.so",
+#if !BUILDFLAG(IS_CHROMEOS)
+      "/usr/lib64/dri/virtio_gpu_drv_video.so",
+      "/usr/lib64/libwayland-server.so.0",
+      "/usr/lib64/gbm/dri_gbm.so",
+#endif
       // If kms_swrast_dri is not usable, swrast_dri is used instead.
       "/usr/lib64/dri/swrast_dri.so",
       "/usr/lib64/dri/kms_swrast_dri.so",
@@ -548,11 +565,13 @@ void LoadArmGpuLibraries() {
 }

 bool LoadAmdGpuLibraries() {
+#if BUILDFLAG(IS_CHROMEOS)
   // Preload the amdgpu-dependent libraries.
   if (nullptr == dlopen("libglapi.so", dlopen_flag)) {
     LOG(ERROR) << "dlopen(libglapi.so) failed with error: " << dlerror();
     return false;
   }
+#endif // IS_CHROMEOS

   const char* radeonsi_lib = "/usr/lib64/dri/radeonsi_dri.so";
 #if defined(DRI_DRIVER_DIR)
@@ -609,7 +628,7 @@ sandbox::syscall_broker::BrokerCommandSet CommandSetForGPU(
   command_set.set(sandbox::syscall_broker::COMMAND_ACCESS);
   command_set.set(sandbox::syscall_broker::COMMAND_OPEN);
   command_set.set(sandbox::syscall_broker::COMMAND_STAT);
-  if (IsChromeOS() &&
+  if (IsLinux() &&
       (options.use_amd_specific_policies ||
        options.use_intel_specific_policies ||
        options.use_nvidia_specific_policies ||
@@ -628,9 +647,9 @@ std::vector<BrokerFilePermission> FilePermissionsForGpu(

   AddVulkanICDPermissions(&permissions);

-  if (IsChromeOS()) {
+  if (IsLinux()) {
     // Permissions are additive, there can be multiple GPUs in the system.
-    AddStandardChromeOsPermissions(&permissions);
+    AddStandardLinuxPermissions(&permissions);
     if (UseV4L2Codec(options)) {
       AddV4L2GpuPermissions(&permissions, options);
     }
@@ -678,7 +697,7 @@ bool LoadLibrariesForGpu(
   if (IsArchitectureArm()) {
     LoadArmGpuLibraries();
   }
-  if (IsChromeOS()) {
+  if (IsLinux()) {
     if (options.use_amd_specific_policies) {
       if (!LoadAmdGpuLibraries())
         return false;
diff --git a/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc b/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc
index 90fdecdb76..f852c64078 100644
--- a/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc
+++ b/sandbox/policy/linux/sandbox_seccomp_bpf_linux.cc
@@ -98,8 +98,8 @@ namespace {
 // nacl_helper needs to be tiny and includes only part of content/
 // in its dependencies. Make sure to not link things that are not needed.
 #if !defined(IN_NACL_HELPER)
-inline bool IsChromeOS() {
-#if BUILDFLAG(IS_CHROMEOS)
+inline bool IsLinux() {
+#if BUILDFLAG(IS_LINUX)
   return true;
 #else
   return false;
@@ -125,7 +125,7 @@ inline bool IsArchitectureArm() {
 std::unique_ptr<BPFBasePolicy> GetGpuProcessSandbox(
     const SandboxSeccompBPF::Options& options,
     MremapPolicy mremap_policy) {
-  if (IsChromeOS() || UseChromecastSandboxAllowlist()) {
+  if (IsLinux() || UseChromecastSandboxAllowlist()) {
     if (IsArchitectureArm()) {
       return std::make_unique<CrosArmGpuProcessPolicy>(
           mremap_policy, base::CommandLine::ForCurrentProcess()->HasSwitch(

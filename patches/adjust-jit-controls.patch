Copyright 2024-2025 The Trivalent Authors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is
distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
---
diff --git a/chrome/browser/chrome_content_browser_client.cc b/chrome/browser/chrome_content_browser_client.cc
index a582e40694..66f7cd437c 100644
--- a/chrome/browser/chrome_content_browser_client.cc
+++ b/chrome/browser/chrome_content_browser_client.cc
@@ -7641,10 +7641,10 @@ bool ChromeContentBrowserClient::IsJitDisabledForSite(
                                          nullptr) == CONTENT_SETTING_BLOCK;
   }
 
-  // Only disable JIT for web schemes.
-  if (!site_url.SchemeIsHTTPOrHTTPS()) {
-    return false;
-  }
+  // Disable JIT & WASM for non-(web|file|extension) schemes.
+  if (!site_url.SchemeIsHTTPOrHTTPS() && !site_url.SchemeIsFile()
+      && !site_url.SchemeIs("chrome-extension"))
+    return true;
 
   return (map && map->GetContentSetting(site_url, site_url,
                                         ContentSettingsType::JAVASCRIPT_JIT) ==
@@ -7654,13 +7654,6 @@ bool ChromeContentBrowserClient::IsJitDisabledForSite(
 bool ChromeContentBrowserClient::AreV8OptimizationsDisabledForSite(
     content::BrowserContext* browser_context,
     const GURL& site_url) {
-  // Only disable optimizations for schemes that might actually load web
-  // content.
-  auto* policy = ChildProcessSecurityPolicy::GetInstance();
-  if (!site_url.is_empty() && !policy->IsWebSafeScheme(site_url.scheme())) {
-    return false;
-  }
-
   Profile* profile = Profile::FromBrowserContext(browser_context);
   auto* map = HostContentSettingsMapFactory::GetForProfile(profile);
   // Special case to determine if any policy is set.
diff --git a/content/browser/renderer_host/render_process_host_impl.cc b/content/browser/renderer_host/render_process_host_impl.cc
index 2e5e7c71a5..228d8795f8 100644
--- a/content/browser/renderer_host/render_process_host_impl.cc
+++ b/content/browser/renderer_host/render_process_host_impl.cc
@@ -3383,8 +3383,21 @@ void RenderProcessHostImpl::AppendRendererCommandLine(
     command_line->AppendSwitchASCII(blink::switches::kJavaScriptFlags,
                                     "--jitless");
   } else if (AreV8OptimizationsDisabled()) {
+    std::string jsflags;
+    bool enable_jitless_wasm =
+#if V8_ENABLE_DRUMBRAKE
+         base::FeatureList::IsEnabled(features::kEnableDrumbrake);
+#else
+         false;
+#endif // V8_ENABLE_DRUMBRAKE
+
+    if (enable_jitless_wasm)
+      jsflags = "--jitless,--wasm_jitless";
+    else
+      jsflags = "--jitless";
+
     command_line->AppendSwitchASCII(blink::switches::kJavaScriptFlags,
-                                    "--disable-optimizing-compilers");
+                                    jsflags);
   }
 
   if (DisallowV8FeatureFlagOverrides()) {
diff --git a/content/public/common/content_features.cc b/content/public/common/content_features.cc
index f087a28da0..5cf9a313fd 100644
--- a/content/public/common/content_features.cc
+++ b/content/public/common/content_features.cc
@@ -19,6 +19,8 @@ namespace features {

 // All features in alphabetical order.

+BASE_FEATURE(EnableDrumbrake, base::FEATURE_ENABLED_BY_DEFAULT);
+
 // Kill switch to guard additional security checks performed by the browser
 // process on opaque origins, such as when verifying source origins for
 // postMessage. See https://crbug.com/40109437.
@@ -1010,7 +1012,7 @@ BASE_FEATURE(DisableProcessReuse, base::FEATURE_DISABLED_BY_DEFAULT);
 // Controls whether SpareRenderProcessHostManager tries to always have a warm
 // spare renderer process around for the most recently requested BrowserContext.
 // This feature is only consulted in site-per-process mode.
-BASE_FEATURE(SpareRendererForSitePerProcess, base::FEATURE_ENABLED_BY_DEFAULT);
+BASE_FEATURE(SpareRendererForSitePerProcess, base::FEATURE_DISABLED_BY_DEFAULT);

 // Controls whether site isolation should use origins instead of scheme and
 // eTLD+1.
diff --git a/content/public/common/content_features.h b/content/public/common/content_features.h
index 34478026bd..be37022a43 100644
--- a/content/public/common/content_features.h
+++ b/content/public/common/content_features.h
@@ -23,6 +23,8 @@ namespace features {
 // BEFORE MODIFYING THIS FILE: If your feature is only used inside content/, add
 // your feature in `content/common/features.h` instead.
 
+CONTENT_EXPORT BASE_DECLARE_FEATURE(kEnableDrumbrake);
+
 // All features in alphabetical order. The features should be documented
 // alongside the definition of their values in the .cc file.
 CONTENT_EXPORT BASE_DECLARE_FEATURE(kAdditionalOpaqueOriginEnforcements);
diff --git a/v8/BUILD.gn b/v8/BUILD.gn
index 8dda88f8..e08a4de7 100644
--- a/v8/BUILD.gn
+++ b/v8/BUILD.gn
@@ -960,6 +960,7 @@ external_v8_defines = [
   "V8_COMPRESS_POINTERS_IN_SHARED_CAGE",
   "V8_31BIT_SMIS_ON_64BIT_ARCH",
   "V8_COMPRESS_ZONES",
+  "V8_ENABLE_DRUMBRAKE",
   "V8_ENABLE_SANDBOX",
   "V8_DEPRECATION_WARNINGS",
   "V8_IMMINENT_DEPRECATION_WARNINGS",
@@ -1000,6 +1001,9 @@ if (v8_enable_pointer_compression) {
 if (v8_enable_pointer_compression || v8_enable_31bit_smis_on_64bit_arch) {
   enabled_external_v8_defines += [ "V8_31BIT_SMIS_ON_64BIT_ARCH" ]
 }
+if (v8_enable_drumbrake) {
+  enabled_external_v8_defines += [ "V8_ENABLE_DRUMBRAKE" ]
+}
 if (v8_enable_sandbox) {
   enabled_external_v8_defines += [ "V8_ENABLE_SANDBOX" ]
 }
@@ -1370,7 +1374,6 @@ config("features") {
     defines += [ "V8_ADVANCED_BIGINT_ALGORITHMS" ]
   }
   if (v8_enable_drumbrake) {
-    defines += [ "V8_ENABLE_DRUMBRAKE" ]
     if (v8_enable_drumbrake_tracing) {
       defines += [ "V8_ENABLE_DRUMBRAKE_TRACING" ]
     }

Copyright 2024-2025 The Trivalent Authors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is
distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
---
diff --git a/chrome/browser/ui/views/tabs/tab_strip.cc b/chrome/browser/ui/views/tabs/tab_strip.cc
index 9b5b2834eb..40e7c7b6fa 100644
--- a/chrome/browser/ui/views/tabs/tab_strip.cc
+++ b/chrome/browser/ui/views/tabs/tab_strip.cc
@@ -2,6 +2,9 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
+#include "ui/views/views_features.h"
+#include "third_party/blink/public/common/features_generated.h"
+
 #include "chrome/browser/ui/views/tabs/tab_strip.h"
 
 #include <stddef.h>
@@ -2186,7 +2189,9 @@ void TabStrip::NewTabButtonPressed(const ui::Event& event) {
     const ui::MouseEvent& mouse = static_cast<const ui::MouseEvent&>(event);
     if (mouse.IsOnlyMiddleMouseButton()) {
       if (ui::Clipboard::IsSupportedClipboardBuffer(
-              ui::ClipboardBuffer::kSelection)) {
+              ui::ClipboardBuffer::kSelection) &&
+          base::FeatureList::IsEnabled(
+                             views::features::kMiddleClickCopyPaste)) {
         ui::Clipboard* clipboard = ui::Clipboard::GetForCurrentThread();
         CHECK(clipboard)
             << "Clipboard instance is not available, cannot proceed with "
diff --git a/ui/views/selection_controller.h b/ui/views/selection_controller.h
index dcc4d40592932..f9a9b002bd956 100644
--- a/ui/views/selection_controller.h
+++ b/ui/views/selection_controller.h
@@ -5,6 +5,10 @@
 #ifndef UI_VIEWS_SELECTION_CONTROLLER_H_
 #define UI_VIEWS_SELECTION_CONTROLLER_H_
 
+// Needed features for middle click controls
+#include "ui/views/views_features.h"
+#include "third_party/blink/public/common/features_generated.h"
+
 #include "base/memory/raw_ptr.h"
 #include "base/time/time.h"
 #include "base/timer/timer.h"
@@ -61,7 +65,8 @@ class VIEWS_EXPORT SelectionController {
   // Sets whether the SelectionController should update or paste the
   // selection clipboard on middle-click. Default is false.
   void set_handles_selection_clipboard(bool value) {
-    handles_selection_clipboard_ = value;
+    handles_selection_clipboard_ = value &&
+          base::FeatureList::IsEnabled(features::kMiddleClickCopyPaste);
   }
 
   // Offsets the double-clicked word's range. This is only used in the unusual
diff --git a/ui/views/views_features.cc b/ui/views/views_features.cc
index 88ca7f0b1f..14be7e5a3a 100644
--- a/ui/views/views_features.cc
+++ b/ui/views/views_features.cc
@@ -9,6 +9,12 @@

 namespace views::features {

+// Controls the behavior of middle-mouse copy and pasting.
+// This may be overridden by the kMiddleClickAutoscroll
+// blink feature.
+BASE_FEATURE(kMiddleClickCopyPaste, base::FEATURE_ENABLED_BY_DEFAULT);
+
+
 // Please keep alphabetized.

 // Used to enable additional a11y attributes when announcing text.
diff --git a/ui/views/views_features.h b/ui/views/views_features.h
index 58063f2452..3adbb7a5fb 100644
--- a/ui/views/views_features.h
+++ b/ui/views/views_features.h
@@ -17,6 +17,8 @@ VIEWS_EXPORT BASE_DECLARE_FEATURE(kEnablePlatformHighContrastInkDrop);
 VIEWS_EXPORT BASE_DECLARE_FEATURE(kEnableTouchDragCursorSync);
 VIEWS_EXPORT BASE_DECLARE_FEATURE(kKeyboardAccessibleTooltipInViews);
 
+VIEWS_EXPORT BASE_DECLARE_FEATURE(kMiddleClickCopyPaste);
+
 }  // namespace views::features
 
 #endif  // UI_VIEWS_VIEWS_FEATURES_H_
diff --git a/third_party/blink/renderer/core/editing/selection_controller.cc b/third_party/blink/renderer/core/editing/selection_controller.cc
index 8f129a1d5d..0ce49f8457 100644
--- a/third_party/blink/renderer/core/editing/selection_controller.cc
+++ b/third_party/blink/renderer/core/editing/selection_controller.cc
@@ -63,6 +63,8 @@
 #include "third_party/blink/renderer/platform/runtime_enabled_features.h"
 #include "ui/gfx/geometry/point_conversions.h"
 
+#include "ui/views/views_features.h"
+
 namespace blink {
 
 SelectionController::SelectionController(LocalFrame& frame)
@@ -1260,7 +1262,9 @@ bool SelectionController::HandlePasteGlobalSelection(
   Frame* focus_frame =
       frame_->GetPage()->GetFocusController().FocusedOrMainFrame();
   // Do not paste here if the focus was moved somewhere else.
-  if (frame_ == focus_frame)
+  if (frame_ == focus_frame &&
+      !RuntimeEnabledFeatures::MiddleClickAutoscrollEnabled() &&
+      base::FeatureList::IsEnabled(views::features::kMiddleClickCopyPaste))
     return frame_->GetEditor().ExecuteCommand("PasteGlobalSelection");
 
   return false;

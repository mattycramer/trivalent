name: Release Trivalent

on:
  workflow_run:
    workflows: ["build-debian"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  resolve-tag:
    name: Resolve release tag
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-24.04
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      should_release: ${{ steps.resolve.outputs.should_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Resolve release tag from workflow SHA
        id: resolve
        run: |
          set -euo pipefail
          git fetch --force --tags origin

          head_sha="${{ github.event.workflow_run.head_sha }}"
          mapfile -t release_tags < <(
            git tag --points-at "${head_sha}" | \
              LC_ALL=C grep -E '^gl-trivalent-v[0-9]+\.[0-9]+\.[0-9]+(-r[0-9]+)?$' || true
          )

          if [ "${#release_tags[@]}" -eq 0 ]; then
            echo "No release tag points at ${head_sha}; skipping release."
            echo "should_release=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          release_tag="$(printf '%s\n' "${release_tags[@]}" | LC_ALL=C sort -V | tail -n 1)"
          echo "Resolved release tag: ${release_tag}"
          echo "release_tag=${release_tag}" >> "${GITHUB_OUTPUT}"
          echo "should_release=true" >> "${GITHUB_OUTPUT}"

  release:
    name: Create GitHub release (Debian x86_64)
    needs: resolve-tag
    if: needs.resolve-tag.outputs.should_release == 'true'
    permissions:
      contents: write
      actions: write
    uses: mattycramer/gh-actions/.github/workflows/release-from-workflow-run.yml@11c09b6ae7ab5a7995b92a3a8ca3210f7f458ead
    with:
      tag: ${{ needs.resolve-tag.outputs.release_tag }}
      tag_prefix: gl-trivalent-v
      allow_revision_suffix: true
      run_id: ${{ github.event.workflow_run.id }}
      artifact_prefix: trivalent-debian-
      tarball_prefix: trivalent-debian-x86_64-
      checksum_prefix: trivalent-sha256-checksums-
      release_name: Trivalent v{version}
    secrets: inherit

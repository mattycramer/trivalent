name: build-debian

on:
  push:
    tags:
      - "gl-trivalent-v*"
  workflow_dispatch:

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-24.04
    outputs:
      package_version: ${{ steps.version.outputs.package_version }}
      ugc_tag: ${{ steps.ugc.outputs.ugc_tag }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Checkout shared actions
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ vars.GH_ACTIONS_SHARED_PROJ }}
          ref: ${{ vars.GH_ACTIONS_SHARED_REF }}
          path: .github/actions/gh-actions
          fetch-depth: 1
          persist-credentials: false

      - name: Require gl-* tag
        if: startsWith(github.ref, 'refs/tags/gl-')
        uses: ./.github/actions/gh-actions/actions/require-gl-tag
        with:
          tag_prefix: gl-

      - name: Ensure tag is on mcr/release
        if: startsWith(github.ref, 'refs/tags/gl-')
        uses: ./.github/actions/gh-actions/actions/require-release-tip
        with:
          release_branch: mcr/release
          allow_merge_commits: "true"

      - name: Read release version
        id: version
        run: |
          set -euo pipefail
          version="$(python3 scripts/trivalent_version.py get)"
          if [ -z "${version}" ]; then
            echo "Failed to read version from VERSION" >&2
            exit 1
          fi
          echo "package_version=${version}" >> "${GITHUB_OUTPUT}"

      - name: Read ungoogled-chromium tag
        id: ugc
        run: |
          set -euo pipefail
          ugc_tag="$(python3 - <<'PY'
          import re
          from pathlib import Path

          data = Path("debian_build.sh").read_text(encoding="utf-8")
          match = re.search(
              r'^\s*readonly\s+UGC_TAG="\$\{UGC_TAG:-([^}]+)\}"',
              data,
              re.M,
          )
          if not match:
              raise SystemExit("Unable to read UGC_TAG from debian_build.sh")
          print(match.group(1).strip())
          PY
          )"
          echo "ugc_tag=${ugc_tag}" >> "${GITHUB_OUTPUT}"

      - name: Validate release tag version
        if: startsWith(github.ref, 'refs/tags/gl-')
        uses: ./.github/actions/gh-actions/actions/validate-tag-version
        with:
          tag_prefix: gl-trivalent-v
          expected_version: ${{ steps.version.outputs.package_version }}
          allow_revision_suffix: "true"
          tag_regex: '^gl-trivalent-v[0-9]+\.[0-9]+\.[0-9]+(-r[0-9]+)?$'

  build-debian:
    name: Build Debian tarball (x86_64)
    runs-on: runs-on=${{ github.run_id }}/runner=x86_64-runner
    needs: setup
    env:
      PACKAGE_VERSION: ${{ needs.setup.outputs.package_version }}
      UGC_TAG: ${{ needs.setup.outputs.ugc_tag }}
      CACHE_DIR: ${{ github.workspace }}/.cache
      WORKDIR: ${{ github.workspace }}/out/debian
      USE_SYSTEM_TOOLCHAIN: "1"
      TRIVALENT_MARCH_NATIVE: "0"
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install base toolchain
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            python3 \
            ninja-build \
            pkg-config \
            nodejs \
            clang \
            lld \
            rustc \
            bindgen \
            rustfmt \
            libssl-dev

      - name: Resolve Chromium build dependencies
        run: |
          set -euo pipefail
          mkdir -p "${CACHE_DIR}" "${WORKDIR}"
          tarball="${CACHE_DIR}/ungoogled-chromium-${UGC_TAG}.tar.gz"
          src_dir="${WORKDIR}/ungoogled-src"
          if [ ! -f "${tarball}" ]; then
            curl -fL --retry 3 --retry-delay 2 \
              --output "${tarball}" \
              "https://github.com/ungoogled-software/ungoogled-chromium/archive/refs/tags/${UGC_TAG}.tar.gz"
          fi
          mkdir -p "${src_dir}"
          if ! find "${src_dir}" -mindepth 1 -maxdepth 1 -type d | grep -q .; then
            tar -xf "${tarball}" -C "${src_dir}"
          fi
          ugc_repo="$(find "${src_dir}" -mindepth 1 -maxdepth 1 -type d | head -n 1)"
          if [ -z "${ugc_repo}" ]; then
            echo "Unable to locate extracted ungoogled-chromium repository." >&2
            exit 1
          fi
          deps_py="${ugc_repo}/build/install-build-deps.py"
          if [ ! -f "${deps_py}" ]; then
            echo "Missing ${deps_py}" >&2
            exit 1
          fi

          mapfile -t packages < <(python3 - "${deps_py}" <<'PY'
          import importlib.util
          import shutil
          import subprocess
          import sys

          path = sys.argv[1]
          spec = importlib.util.spec_from_file_location("deps", path)
          mod = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(mod)

          options = mod.parse_args([])
          packages = mod.package_list(options)

          include = {
              "libgtk-3-dev",
              "libpipewire-0.3-dev",
              "libx11-xcb-dev",
              "libxkbcommon-dev",
              "libnss3-dev",
              "libglib2.0-dev",
              "libudev-dev",
          }

          exclude = {
              "libcups2-dev",
              "libcups2",
              "binutils-arm-linux-gnueabihf",
              "binutils-mipsel-linux-gnu",
              "binutils-mips64el-linux-gnuabi64",
              "binutils-aarch64-linux-gnu",
              "lib32z1",
              "dbus-x11",
              "openbox",
              "xcompmgr",
              "lighttpd",
              "xserver-xorg-video-dummy",
              "xvfb",
              "rpm",
              "cdbs",
              "devscripts",
          }

          replace_map = {
              "libasound2": "libasound2t64",
              "libatk1.0-0": "libatk1.0-0t64",
              "libatspi2.0-0": "libatspi2.0-0t64",
              "libbrlapi0.5": "libbrlapi0.8",
              "libgtk-3-0": "libgtk-3-0t64",
              "libjpeg62-dev": "libjpeg62-turbo-dev",
              "libjpeg62": "libjpeg62-turbo",
              "libncurses5": "libncurses6",
              "libnspr4-0d": "libnspr4",
              "libnss3-1d": "libnss3",
              "libpng12-0": "libpng16-16",
          }

          def candidate_exists(pkg):
              result = subprocess.run(
                  ["apt-cache", "policy", pkg],
                  check=False,
                  stdout=subprocess.PIPE,
                  stderr=subprocess.DEVNULL,
                  text=True,
              )
              for line in result.stdout.splitlines():
                  if line.strip().startswith("Candidate:"):
                      return "(none)" not in line
              return False

          resolved = []
          for pkg in packages:
              if pkg in exclude:
                  continue
              mapped = replace_map.get(pkg, pkg)
              if mapped != pkg and candidate_exists(mapped):
                  resolved.append(mapped)
                  continue
              if candidate_exists(pkg):
                  resolved.append(pkg)
                  continue
          packages = resolved
          for pkg in include:
              if pkg in packages:
                  continue
              if candidate_exists(pkg):
                  packages.append(pkg)

          if shutil.which("git"):
              exclude.add("git-core")
          for pkg in sorted(set(packages)):
              print(pkg)
          PY
          )

          if [ "${#packages[@]}" -gt 0 ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "${packages[@]}"
          fi

      - name: Build Debian binaries
        run: |
          set -euo pipefail
          ./debian_build.sh

      - name: Package Debian install tree
        run: |
          set -euo pipefail
          install_dir="${WORKDIR}/install"
          if [ ! -d "${install_dir}" ]; then
            echo "Missing install tree at ${install_dir}" >&2
            exit 1
          fi
          tarball="trivalent-debian-x86_64-${PACKAGE_VERSION}.tar.gz"
          tar --sort=name --owner=0 --group=0 --numeric-owner \
            -czf "${tarball}" -C "${install_dir}" .
          sha256sum "${tarball}" > "trivalent-sha256-checksums-${PACKAGE_VERSION}.txt"

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trivalent-debian-${{ env.PACKAGE_VERSION }}
          path: |
            trivalent-debian-x86_64-${{ env.PACKAGE_VERSION }}.tar.gz
            trivalent-sha256-checksums-${{ env.PACKAGE_VERSION }}.txt
          if-no-files-found: error
          retention-days: 14

#!/bin/bash

# PLACE YOUR CONFIGS IN SEPERATE FILES
# Changes to this file may not persist, do not depend on changes made to this file
# Save configs in '/etc/trivalent/trivalent.conf.d' named '<name>.conf'
# Do not use 'CHROMIUM_SYSTEM_FLAGS' in these files, only 'CHROMIUM_FLAGS'
# Do not use the '--enable-features' flag, use 'FEATURES+='
# Always prefix a comma to features

# Copyright 2025 The Trivalent Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed under the License is
# distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and limitations under the License.

# USE_WAYLAND=[true|false|unknown]
if command -v nvidia-smi && [ -n "$DISPLAY" ]; then
	echo "Nvidia + X11 detected"

	# Nvidia may or may not use Wayland when Xwayland is available
	# We don't want to do anything specific to either Wayland or X11 in this case
	USE_WAYLAND="unknown"
elif [ "$USE_WAYLAND" == "true" ]; then
    CHROMIUM_SYSTEM_FLAGS+=" --ozone-platform=wayland"
elif [ -z "$USE_WAYLAND" ]; then
	case "$XDG_SESSION_TYPE" in
	   wayland)
	      USE_WAYLAND="true"
	      ;;
	   x11)
	      USE_WAYLAND="false"
	      ;;
	   *)
	      USE_WAYLAND="unknown"
	      ;;
	esac
fi
[ "$USE_WAYLAND" == "false" ] && CHROMIUM_SYSTEM_FLAGS+=" --ozone-platform=x11"

# Other architectures are not tested for and should not be included yet
# ENABLE_VULKAN=[true|false]
if [ "$ARCH" == "x86_64" ] ; then
	if [ "$USE_WAYLAND" == "false" ]; then
		CHROMIUM_SYSTEM_FLAGS+=" --enable-gpu-memory-buffer-video-frames"
		CHROMIUM_SYSTEM_FLAGS+=" --enable-zero-copy"
		CHROMIUM_SYSTEM_FLAGS+=" --ignore-gpu-blocklist"
		CHROMIUM_SYSTEM_FLAGS+=" --disable-gpu-driver-bug-workaround"

		# Enable Vulkan
		# (Vulkan is not supported on Wayland, it is also experimental)
		ENABLE_VULKAN="true"
	fi

	if [ "$ENABLE_VULKAN" == "true" ]; then
		CHROMIUM_SYSTEM_FLAGS+=" --use-angle=vulkan --use-vulkan"
		FEATURES+=",Vulkan,DefaultANGLEVulkan,VulkanFromANGLE,VaapiIgnoreDriverChecks"
	fi
fi

[ "$BROWSER_LOG_LEVEL" >= 2 ] && CHROMIUM_SYSTEM_FLAGS+=" --enable-logging=stderr --v=1"

[ -n "$FEATURES" ] && CHROMIUM_SYSTEM_FLAGS+=" --enable-features=$FEATURES"
